---
- name: Generate EC signing keys
  command: |
    cd {{ project_path }}
    chmod +x ./scripts/gen_keys.sh
    ./scripts/gen_keys.sh
  become: false
  args:
    creates: "{{ project_path }}/keys/private_key.pem.enc"

- name: Stop and remove existing containers
  command: docker compose --env-file .env down --remove-orphans
  args:
    chdir: "{{ project_path }}"
  become: false

- name: Build and pull images
  command: docker compose --env-file .env build --pull
  args:
    chdir: "{{ project_path }}"
  become: false

- name: Build and start containers
  command: docker compose --env-file .env up -d --build
  args:
    chdir: "{{ project_path }}"
  become: false
  register: compose_output

- name: Wait for containers to be healthy
  pause:
    seconds: 30

- name: Run database migrations
  command: docker exec my-love-backend alembic upgrade head
  become: false
  retries: 3
  delay: 10
